# LSL Tools WSIS task

## Overview
In LSL instance segmentation WS mode, users need to prepare images with bounding boxes annotations (COCO format) as training data. Then these data will be used to perform auto-labelling by weakly supervised instance segmentation. And users need to provide a validation data with both boxes annotations and segmentation(COCO format) as valid data to measure the quality of pseudo label generated by auto-labeling.

## Download Pretrained Model
```
cd ${PATH_TO_LSL_Tools}
python download_pretrained_models.py --task wsis
# The pretrained models will be downloaded in ${PATH_TO_LSL_Tools}/lsl_tools/pretrain_weight
```

## Start

### Create a WSIS task
```
    # Create a LSL project
    mkdir ${PATH_TO_PROJECT}
    cd ${PATH_TO_PROJECT}
    lsl create --task wsis

```

### Import dataset
```
    # Import train data (COCO format)
    lsl import  --image <your/train/data/dir> \
                --annotation <your/train/data/in/coco/json/format>
                --name <train_data_source_name>

    # Optionally import validation data (COCO format)
    lsl import  --image <your/validation/image/folder> \
                --annotation <your/validation/data/in/coco/json/format>
                --name <validation_data_source_name>    

    # Import target data (auto-labeling target)
    lsl import  --unlabeled <your/test/data/dir> \
                --name <test_data_source_name>


```

### Train
```
    # Start auto-labelling
    # Adaptive number of iteration will be used if `--iter` not specified    
    lsl auto-label  --train ${train_data_source_name} \
                    --valid ${validation_data_source_name} \
                    --test ${test_data_source_name} \
                    [--iter ${number_of_training_iterations}] \
                    [--conf ${confidence_score}]
                    
```
The training iteration is specified by `--iter` argument. If not provided, an adaptive number of will be used. If iteration is set to less than one epoch, the training may still continue until a full epoch is completed.  

The best model after fintuned will be saved under `${PATH_TO_PROJECT}/.lsl/${train_data_source_name}/model_best.pth`. 
Retraining the LSL model in the same project will trigger a prompt to confirm whether to overwrite the original best model. The prompt will appear for each model used.
If 'N' is selected, the training of this model will be skipped. 

The pseudo labels of target data will be saved under `${PATH_TO_PROJECT}/.lsl/${train_data_source_name}/inference/${test_data_source_name}/pseudo_mask_label.json`.

### Visualation
After auto-labelling, user can preview detection result on test data source.

```
    # Preview detection result on test data source
    # Currently preview of FSOD-GLIP isn't supported
    # task-fsod currently does not support preview
    lsl preview --train ${train_data_source_name} \
                --name ${test_data_source_name} \
                [--conf ${confidence_score}]

```
The confidence_score argument can be used to filter out low scored detections.


